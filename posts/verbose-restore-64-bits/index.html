<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Verbose restore a 64 bits iPhone with checkm8" /><meta property="og:locale" content="en" /><meta name="description" content="Introduction In this post, you’ll learn how to perform a verbose restore on a 64 bits iPhone using checkm8. While this should work on 32 bits devices too, I didn’t have time to try it out yet. I will update these instructions or make a new blogpost once I have done it on such a device." /><meta property="og:description" content="Introduction In this post, you’ll learn how to perform a verbose restore on a 64 bits iPhone using checkm8. While this should work on 32 bits devices too, I didn’t have time to try it out yet. I will update these instructions or make a new blogpost once I have done it on such a device." /><link rel="canonical" href="https://machxnu.github.io/posts/verbose-restore-64-bits/" /><meta property="og:url" content="https://machxnu.github.io/posts/verbose-restore-64-bits/" /><meta property="og:site_name" content="MachXNU" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-05-07T14:00:00+02:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Verbose restore a 64 bits iPhone with checkm8" /><meta name="twitter:site" content="@machxnu" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-05-07T14:00:00+02:00","datePublished":"2022-05-07T14:00:00+02:00","description":"Introduction In this post, you’ll learn how to perform a verbose restore on a 64 bits iPhone using checkm8. While this should work on 32 bits devices too, I didn’t have time to try it out yet. I will update these instructions or make a new blogpost once I have done it on such a device.","headline":"Verbose restore a 64 bits iPhone with checkm8","mainEntityOfPage":{"@type":"WebPage","@id":"https://machxnu.github.io/posts/verbose-restore-64-bits/"},"url":"https://machxnu.github.io/posts/verbose-restore-64-bits/"}</script><title>Verbose restore a 64 bits iPhone with checkm8 | MachXNU</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="MachXNU"><meta name="application-name" content="MachXNU"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src=" /img/eve.png " alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">MachXNU</a></div><div class="site-subtitle font-italic">Articles and tutorials about iOS, macOS and Linux</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/MachXNU" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/machxnu" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['example','doamin.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="https://t.me/MachXNU" aria-label="telegram" > <i class="fab fa-telegram"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Verbose restore a 64 bits iPhone with checkm8</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Verbose restore a 64 bits iPhone with checkm8</h1><div class="post-meta text-muted"><div> By <em> <a href="https://twitter.com/machxnu">MachXNU</a> </em></div><div class="d-flex"><div> <span> Posted <em class="timeago" data-ts="1651924800" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2022-05-07 </em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="2095 words"> <em>11 min</em> read</span></div></div></div><div class="post-content"><h2 id="introduction"><span class="mr-2">Introduction</span><a href="#introduction" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>In this post, you’ll learn how to perform a verbose restore on a 64 bits iPhone using checkm8.</p><blockquote class="prompt-info"><div><p>While this should work on 32 bits devices too, I didn’t have time to try it out yet. I will update these instructions or make a new blogpost once I have done it on such a device.</p></div></blockquote><h3 id="why-do-you-want-to-do-this-"><span class="mr-2">Why do you want to do this ?</span><a href="#why-do-you-want-to-do-this-" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><ol><li>Maybe because you are curious and wonder what’s happening behind the scenes. For sure, <code class="language-plaintext highlighter-rouge">idevicerestore</code> provides a interesting log for you to read, but you could actually get much more than this simple log.<li>When trying to dualboot an iPhone, I have trouble with the <code class="language-plaintext highlighter-rouge">apfs_invert()</code> method, and I thought comparing with a normal restore would help me diagnosing and hopefully solving my issues.<li>Although the restore log can be accessed via serial output, it requires a DCSD cable and, even if such a cable only costs around 30$, I didn’t have any DCSD cable to use. So, let’s use a free method until buying a DCSD cable !</ol><h3 id="where-to-start-"><span class="mr-2">Where to start ?</span><a href="#where-to-start-" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p><a href="https://twitter.com/nyan_satan">@nyan_satan</a> wrote a simple tutorial which you can find <a href="https://nyansatan.github.io/verbose-restore/">here</a> decribing how to patch graphical routines. While this is definitely a great starting point, we also have to load our patch files, and this is what this tutorial is all about.</p><h2 id="the-ios-restore-process"><span class="mr-2">The iOS restore process</span><a href="#the-ios-restore-process" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><blockquote class="prompt-danger"><div><p>I am not an iOS expert, and what I’m saying might be wrong. Read it at your own risk. The following explanations are based on what I know and have understood from this project. I can’t guarantee it’s 100% (or even 1%) true. You’ll have been warned.</p></div></blockquote><h4 id="update-or-erase-"><span class="mr-2">Update or erase ?</span><a href="#update-or-erase-" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4></h4><p>For the sake of this demo, we’ll proceed to a so-called “update” restore. <br /> With iOS devices, there are 2 restore fashions : “update” and “erase”.<br /> “Erase” restores perform some more operations on the disk (they wipe user data), and unfortunately I’ve not been able to perform such restores with UI routines disabled. On the other hand, “update” restore seems more cooperative, so that’s the restore style we’ll use.</p><h4 id="what-happens-during-a-restore-"><span class="mr-2">What happens during a restore ?</span><a href="#what-happens-during-a-restore-" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4></h4><p>We’ll start with a device placed in recovery mode.<br /> At this stage, <code class="language-plaintext highlighter-rouge">iBSS</code> and <code class="language-plaintext highlighter-rouge">iBEC</code> are already loaded and the device is waiting for the next boot images, including (but not limited to) <code class="language-plaintext highlighter-rouge">kernelcache</code>, a <code class="language-plaintext highlighter-rouge">ramdisk</code> and its associated <code class="language-plaintext highlighter-rouge">trustcache</code>, <code class="language-plaintext highlighter-rouge">devicetree</code>, etc.<br /> But here, we don’t have to care that much about what has to be sent, because <code class="language-plaintext highlighter-rouge">idevicerestore</code> already sends all the necessary files for us in the correct order.<br /> Our role “only” boils down to giving <code class="language-plaintext highlighter-rouge">idevicerestore</code> a valid IPSW file to work with.<br /> This sounds simple, but since we are patching things out, we’re breaking the chain of trust at some point, and restore will thus fail if we don’t do anything.</p><h4 id="what-do-we-have-to-patch-"><span class="mr-2">What do we have to patch ?</span><a href="#what-do-we-have-to-patch-" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4></h4><p>During a restore, the restore software (either iTunes, <code class="language-plaintext highlighter-rouge">idevicerestore</code>, <code class="language-plaintext highlighter-rouge">futurerestore</code> or whatever) sends a ramdisk, among other files. <br /> An IPSW contains 2 ramdisks, one for each restore type (their exact name can be found on <a href="https://www.theiphonewiki.com">The iPhone Wiki</a>, in the Firmware Keys section).<br /> Inside the ramdisks, at path <code class="language-plaintext highlighter-rouge">/usr/local/bin</code> is a Mach-O executable which effectively performs the restore operations on the device side (the PC also plays its role, but the iPhone’s restore code is located in this executable). <br /> For “erase” variants, this executable is called <code class="language-plaintext highlighter-rouge">restored_external</code> while in “update” variants, it’s called <code class="language-plaintext highlighter-rouge">restored_update</code>.<br /> This is the executable we need to patch : it’s responsible for performing the restore but also handles the UI part (displaying the Apple logo and the progress bar).</p><h4 id="some-more-complications"><span class="mr-2">Some more complications</span><a href="#some-more-complications" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4></h4><p>Of course, it would be too easy to just patch this executable, repack the IPSW and restore it, right ?<br /> That’s because, when patching <code class="language-plaintext highlighter-rouge">restored_update</code>, we altered its signature. Of course, we will fakesign it with <code class="language-plaintext highlighter-rouge">ldid2</code> but the kernel, if unpatched, will reject this signature.<br /> So we need to patch the kernel (we’ll see how to do this later on). But patching the kernel alters its signature, so <code class="language-plaintext highlighter-rouge">iBEC</code> won’t load it. We thus need to patch both <code class="language-plaintext highlighter-rouge">iBSS</code> and <code class="language-plaintext highlighter-rouge">iBEC</code> and this brings us back to <strong>checkm8</strong> !<br /> Patching signature validations if what will make everything possible.</p><blockquote class="prompt-danger"><div><p>Since we are flashing patched <code class="language-plaintext highlighter-rouge">iBSS</code> and <code class="language-plaintext highlighter-rouge">iBEC</code> to our device, these images won’t be validated if SecureROM is not patched. In other words, after this restore, you’ll have to tether boot your device.<br /> However, this can be easily reverted by restoring a normal IPSW : this will flash valid boot images, which will be booted untethered.</p></div></blockquote><h4 id="credits"><span class="mr-2">Credits</span><a href="#credits" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4></h4><p>As I mentionned earlier, I got the idea to do this project thanks to <a href="https://twitter.com/nyan_satan">@nyan_satan</a>’s blog post.<br /> I also followed <a href="https://twitter.com/mcg29_">@mcg29_</a>’s <a href="https://dualbootfun.github.io/dualboot/">dualboot guide</a> for learning how to load a custom bootchain.</p><h2 id="requirements"><span class="mr-2">Requirements</span><a href="#requirements" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>Here are the tools you need for this project (I recommend you copy the compiled executables to <code class="language-plaintext highlighter-rouge">/usr/local/bin</code> on your Mac to always have them in your path) :</p><ul><li><a href="https://github.com/xerub/img4lib">img4lib</a> aka <code class="language-plaintext highlighter-rouge">img4</code> by @xerub<li><a href="https://github.com/dayt0n/kairos">kairos</a> by @dayt0n<li><a href="https://github.com/Ralph0045/Kernel64Patcher">Kernel64Patcher</a> by @Ralph0045<li>ldid2 (install it with <code class="language-plaintext highlighter-rouge">brew install ldid2</code>)<li><a href="https://github.com/exploit3dguy/asr64_patcher">asr64_patcher</a> by @md<li>idevicerestore (compile everything with <a href="https://gist.github.com/matteyeux/d7d8041a41ee8d664aaf5c3b99556ada">this</a> by @matteyeux)</ul><h2 id="before-you-begin"><span class="mr-2">Before you begin</span><a href="#before-you-begin" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>If you’re not really familiar with iOS boot/restore processes, I recommend you first do the following :</p><ol><li>Restore a normal IPSW with <code class="language-plaintext highlighter-rouge">idevicerestore</code> and read the log.<li>Read the <a href="https://dualbootfun.github.io/dualboot/">dualboot guide</a> by <a href="https://twitter.com/Ralph0045">@Ralph0045</a> and <a href="https://twitter.com/mcg29_">@Ralph0045</a> and try it yourself.<li>Verbose boot your iPhone. It’s an absolutely basic thing you MUST master well. It’s trivial, but do it by hand, not with checkra1n :)</ol><h2 id="the-general-idea"><span class="mr-2">The general idea</span><a href="#the-general-idea" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><ol><li>Extract a release IPSW (the latest one, which can be restored without blobs). While it is theoretically possible to restore with <code class="language-plaintext highlighter-rouge">futurerestore</code> to an unsigned version, I didn’t try it yet and can’t confirm it works out of the box.<li>Patch <code class="language-plaintext highlighter-rouge">iBSS</code> and <code class="language-plaintext highlighter-rouge">iBEC</code> to load custom images ; and replace them in the original IPSW.<li>Patch the <code class="language-plaintext highlighter-rouge">kernelcache</code> to disable AMFI and replace it in the original IPSW.<li>Extract the “update” ramdisk and locate <code class="language-plaintext highlighter-rouge">restored_update</code>.<li>Patch UI routines in <code class="language-plaintext highlighter-rouge">restored_update</code>, restore its entitlements and fakesign it.<li>Patch <code class="language-plaintext highlighter-rouge">asr</code> to force image validation.<li>Pack back the ramdisk.<li>Pack back the IPSW and restore it.</ol><blockquote class="prompt-info"><div><p>You are free to organise the project’s folders as you wish, so be careful since your commands may vary from mine.<br /> Copy-pasting is never a good idea, and you won’t learn anything.<br /> As for me, I’ve created a <code class="language-plaintext highlighter-rouge">restore</code> folder for all the stuffs with inside, the stock IPSW extracted in a folder called <code class="language-plaintext highlighter-rouge">stock</code>, and the modded IPSW in a folder called <code class="language-plaintext highlighter-rouge">modded</code>.</p></div></blockquote><h2 id="patching-ibss-and-ibec"><span class="mr-2">Patching <code class="language-plaintext highlighter-rouge"><span class="mr-2">iBSS</code> and <code class="language-plaintext highlighter-rouge"><span class="mr-2">iBEC</code></span><a href="#patching-ibss-and-ibec" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>If you have already verbose booted your iPhone, this part should look familiar to you.</p><blockquote class="prompt-info"><div><p>I’m using the kbag method to decrypt <code class="language-plaintext highlighter-rouge">iBSS</code> and <code class="language-plaintext highlighter-rouge">iBEC</code>. Thanks to this, I don’t rely on keys from The iPhone Wiki.</p></div></blockquote><p>For <code class="language-plaintext highlighter-rouge">iBSS</code> (for example), first extract its kbag</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>img4 <span class="nt">-i</span> iBSS.<span class="k">*</span>.RELEASE.im4p <span class="nt">-b</span>
</pre></table></code></div></div><p>The kbag is the first line in the output.<br /> Then, place your iPhone in DFU mode, exploit it with <code class="language-plaintext highlighter-rouge">./ipwndfu -p</code> but don’t remove sigchecks yet ! Instead, run :</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>./ipwndfu <span class="nt">--decrypt-gid</span><span class="o">=</span>&lt;kbag&gt;
</pre></table></code></div></div><p>This is the decrypted kbag (aka <code class="language-plaintext highlighter-rouge">dkbag</code>). We can now use it to decrypt <code class="language-plaintext highlighter-rouge">iBSS</code> :</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>img4 <span class="nt">-i</span> iBSS.<span class="k">*</span>.RELEASE.im4p <span class="nt">-o</span> ibss.raw <span class="nt">-k</span> &lt;dkbag&gt; 
</pre></table></code></div></div><p>Then patch it with <code class="language-plaintext highlighter-rouge">kairos</code> :</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>kairos ibss.raw ibss.pwn
</pre></table></code></div></div><p>And pack it back to <code class="language-plaintext highlighter-rouge">im4p</code> :</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>img4 <span class="nt">-i</span> ibss.pwn <span class="nt">-o</span> ibss.im4p.pwn <span class="nt">-A</span> <span class="nt">-T</span> ibss
</pre></table></code></div></div><blockquote class="prompt-warning"><div><p>Note that unlinke the dualboot process, a verbose restore doesn’t need boot components to be signed ! In fact, you MUSN’T sign them ! Because <code class="language-plaintext highlighter-rouge">idevicerestore</code> will do this for you.<br /> But when booting a ramdisk manually, you must send components that are already signed.</p></div></blockquote><p>Do the same with <code class="language-plaintext highlighter-rouge">iBEC</code>, but don’t forget to add the verbose flag : <code class="language-plaintext highlighter-rouge">kairos ibss.raw ibss.pwn -b "-v"</code><br /> Finally, replace the original files in <code class="language-plaintext highlighter-rouge">Firmware/dfu</code> with these.</p><h2 id="patching-the-kernel"><span class="mr-2">Patching the Kernel</span><a href="#patching-the-kernel" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>The procedure is exactly the same as what’s described in the dualboot guide <a href="https://dualbootfun.github.io/dualboot/patching_bootchain.html">here</a>.<br /> That’s because we just need to patch AMFI, no need for anything fancier than that.<br /> Here are the instructions :</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>img4 <span class="nt">-i</span> kernelcache.release.<span class="k">*</span> <span class="nt">-o</span> kcache.raw
Kernel64Patcher kcache.raw kcache.patched <span class="nt">-a</span>
bsdiff kcache.raw kcache.patched kc.patch
img4 <span class="nt">-i</span> kernelcache.release.<span class="k">*</span> <span class="nt">-o</span> kcache.im4p.pwn <span class="nt">-T</span> rkrn <span class="nt">-P</span> kc.bpatch
</pre></table></code></div></div><blockquote class="prompt-tip"><div><p>Note that we need to add the <code class="language-plaintext highlighter-rouge">rkrn</code> tag to specify our kernel is a restore kernel.<br /> You can find a complete list of all possible tags <a href="https://www.theiphonewiki.com/wiki/TYPE">here</a>.</p></div></blockquote><p>Finally, replace the kernel inside the IPSW with your patched one.</p><h2 id="patching-the-ramdisk"><span class="mr-2">Patching the ramdisk</span><a href="#patching-the-ramdisk" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>First, let’s prepare the ramdisk to access its content.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>img4 <span class="nt">-i</span> &lt;update-ramdisk&gt; <span class="nt">-o</span> ramdisk.dmg
</pre></table></code></div></div><p>Then mount the ramdisk (either double-click on the dmg, or use <code class="language-plaintext highlighter-rouge">hdiutil</code>).</p><h2 id="patching-ui-routines"><span class="mr-2">Patching UI routines</span><a href="#patching-ui-routines" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>That is the whole point of what we want to do : disable UI routines.<br /> First, load <code class="language-plaintext highlighter-rouge">/usr/local/bin/restored-update</code> in Hopper and search for a function called <code class="language-plaintext highlighter-rouge">ramrod_display</code> (as @nyan_satan describes <a href="https://nyansatan.github.io/verbose-restore/">here</a>).<br /> <img data-src="/img/2022-05-07-VERBOSE-RESTORE/ramrod.png" alt="Desktop View" class="shadow" data-proofer-ignore> <em>Locate the _ramrod_display_set_progress function</em> A function of interest here is <code class="language-plaintext highlighter-rouge">_ramrod_display_set_progress</code> which calls <code class="language-plaintext highlighter-rouge">ramrod_display_set_granular_progress_forced</code>.<br /> The latter function seems to effectively perform the display-related operations, so we will disable calls to this function.<br /> To do this, replace the branch operation in <code class="language-plaintext highlighter-rouge">_ramrod_display_set_progress</code> by a return instruction, as follows : <img data-src="/img/2022-05-07-VERBOSE-RESTORE/disabled.png" alt="Desktop View" class="shadow" data-proofer-ignore> <em>Branch instruction is replaced by a ret</em></p><p>Finally, follow my other blog post about <a href="http://127.0.0.1:4000/posts/13-00-PATCH/">Patching an executable with Python</a> to apply this patch without a complete Hopper license. The method is strictly the same, and you shouldn’t have much trouble adapting this post to your case.<br /> Once our patch is applied, we musn’t forget to fakesign the binary and restore its entitlements :</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>ldid2 <span class="nt">-e</span> restored_update <span class="o">&gt;</span> restored_plist.ents
patcher.py restored_update <span class="c">#This applies the patch</span>
<span class="nb">mv </span>restored_update_patched restored_update
<span class="nb">chmod </span>755 restored_update
ldid2 <span class="nt">-Srestored_plist</span>.ents restored_update
</pre></table></code></div></div><h2 id="patching-asr"><span class="mr-2">Patching <code class="language-plaintext highlighter-rouge"><span class="mr-2">asr</code></span><a href="#patching-asr" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>As shown in <a href="https://www.theiphonewiki.com/wiki/ASR">the corresponding page on The iPhone Wiki</a>, <code class="language-plaintext highlighter-rouge">/usr/sbin/asr</code> performs a check that we need to patch.<br /> While we could do this by hand, @md has written a convenient program which does this automatically : <a href="https://github.com/exploit3dguy/asr64_patcher">asr64_patcher</a><br /> And of course, we mustn’t forget neither about entitlements and fakesign.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>asr64_patcher asr asr_patched
ldid2 <span class="nt">-e</span> asr <span class="o">&gt;</span> asr_ents.plist
ldid2 <span class="nt">-S</span> asr_ents.plist asr_patched
<span class="nb">mv </span>asr_patched asr
</pre></table></code></div></div><h3 id="packing-back-the-ramdisk"><span class="mr-2">Packing back the ramdisk</span><a href="#packing-back-the-ramdisk" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>All operations on the ramdisk are now done, let’s pack it back for restore :</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>hdiutil detach /Volumes/<span class="k">*</span>.arm64<span class="k">*</span>RamDisk <span class="c">#Optionnal : unmount your ramdisk</span>
img4 <span class="nt">-i</span> ramdisk.dmg <span class="nt">-o</span> &lt;update-ramdisk-name&gt;.dmg <span class="nt">-A</span> <span class="nt">-T</span> rdsk
</pre></table></code></div></div><p>Again, replace the ramdisk inside the IPSW with the one we just generated.</p><h2 id="packing-back-the-ipsw"><span class="mr-2">Packing back the IPSW</span><a href="#packing-back-the-ipsw" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>Be careful not to zip the folder containing your files, but the files themselves !<br /> In the Finder, select all files, then right-click &gt; <code class="language-plaintext highlighter-rouge">Compress</code><br /> <img data-src="/img/2022-05-07-VERBOSE-RESTORE/compress.png" alt="Desktop View" class="shadow" data-proofer-ignore></p><p>If you want to do this programmatically (inside a script for example), do the following :</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nb">cd</span> &lt;the folder&gt;
zip <span class="nt">-r</span> &lt;output-path&gt;/custom.ipsw <span class="k">*</span>
</pre></table></code></div></div><p>The idea is that must be inside the folder already and zip all files next to you. If not, you will also zip the path to your files and that will corrupt your IPSW.</p><h2 id="preparing-your-device"><span class="mr-2">Preparing your device</span><a href="#preparing-your-device" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>Now we need to prepare our device to accept our custom IPSW.<br /> While using <code class="language-plaintext highlighter-rouge">ipwndfu</code> is indeed the solution, here are the detailed steps.<br /> First, prepare a “normal” combo of <code class="language-plaintext highlighter-rouge">iBSS</code> + <code class="language-plaintext highlighter-rouge">iBEC</code> that you would use for verbose booting.<br /> In fact, they are exactly the same as what we generated earlier, but these DO NEED to be signed with an IM4M blob !</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>img4 <span class="nt">-i</span> ibss.pwn <span class="nt">-o</span> ibss.im4p.pwn <span class="nt">-A</span> <span class="nt">-T</span> ibss <span class="nt">-M</span> IM4M
</pre></table></code></div></div><p>Once they are ready, exploit your device with <code class="language-plaintext highlighter-rouge">./ipwndfu -p</code>.<br /> Then, remove sigchecks (<code class="language-plaintext highlighter-rouge">python rmsigchks.py</code>).<br /> Finally, send <code class="language-plaintext highlighter-rouge">iBSS</code> and <code class="language-plaintext highlighter-rouge">iBEC</code> :</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>irecovery <span class="nt">-f</span> ibss
irecovery <span class="nt">-f</span> ibec
</pre></table></code></div></div><p>The device is now in pwnRecovery, and can still accept unsigned images.</p><h2 id="restoring"><span class="mr-2">Restoring</span><a href="#restoring" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>It’s the most trivial part of the job :</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>idevicerestore custom.ipsw
</pre></table></code></div></div><blockquote class="prompt-tip"><div><p>With this command, <code class="language-plaintext highlighter-rouge">idevicerestore</code> only performs an “update” restore and thus, uses the Update ramdisk.<br /> Specifying the <code class="language-plaintext highlighter-rouge">--erase</code> flag will make it use the Erase ramdisk.</p></div></blockquote><p>If you did everything carefully and correctly, you will see the complete restore log right on your device’s screen !</p><blockquote class="twitter-tweet"><p lang="en" dir="ltr">I’ve successfully done a verbose restore on my iPhone 5s.<br />I followed <a href="https://twitter.com/nyan_satan?ref_src=twsrc%5Etfw">@nyan_satan</a>’s blog post to disable the graphical interface, and then modified the Update Ramdisk to load it with checkm8 <a href="https://t.co/WDmWTMequb">pic.twitter.com/WDmWTMequb</a></p>&mdash; MachXNU (@MachXNU) <a href="https://twitter.com/MachXNU/status/1520327253707706368?ref_src=twsrc%5Etfw">April 30, 2022</a></blockquote><script async="" src="https://platform.twitter.com/widgets.js" charset="utf-8"></script><h2 id="conclusion"><span class="mr-2">Conclusion</span><a href="#conclusion" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>I tried to be as clear and explanatory as possible. However, if you’re still having trouble, feel free to contact me on Twitter or Telegram and I’ll do my best to help you !<br /> And if you are thinking “Bruh, what a spoon-feeding tutorial for noobs”, remember that you’ve once been a noob too, and explanations are never useless ! Before knowing somehing by heart, you had to learn it and my goal is to make this learning easier and faster !</p></div><div class="post-tail-wrapper text-muted"><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Verbose restore a 64 bits iPhone with checkm8 - MachXNU&amp;url=https://machxnu.github.io/posts/verbose-restore-64-bits/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Verbose restore a 64 bits iPhone with checkm8 - MachXNU&amp;u=https://machxnu.github.io/posts/verbose-restore-64-bits/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https://machxnu.github.io/posts/verbose-restore-64-bits/&amp;text=Verbose restore a 64 bits iPhone with checkm8 - MachXNU" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/Cross-compiling-radare2-for-armhf-and-Buildroot/">Cross-compiling radare2 for armhf and Buildroot</a><li><a href="/posts/Enabling-framebuffer-on-qemu_arm_versatile-and-buildroot/">Enabling framebuffer on qemu_arm_versatile and Buildroot</a><li><a href="/posts/macOS-theming/">Fulling theming macOS Big Sur</a></ul></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/Debugger-Android-no-root/"><div class="card-body"> <em class="timeago small" data-ts="1744372800" > 2025-04-11 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Run Android apps in a debugger without root</h3><div class="text-muted small"><p> Introduction In this article, I will explain how to run a compiled third-party Android app in a debugger like lldb on a non-rooted device. Prerequisites Install Android Studio and download the S...</p></div></div></a></div><div class="card"> <a href="/posts/Frida-gadget-on-iOS-18/"><div class="card-body"> <em class="timeago small" data-ts="1743350400" > 2025-03-30 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Frida Gadget/Objection on iOS 18</h3><div class="text-muted small"><p> Introduction Running Frida gadget on (jailed) iOS 18 can be suprisingly more difficult that expected. In this article, I am providing a full method to get Frida Gadget running on such a device. P...</p></div></div></a></div><div class="card"> <a href="/posts/Cross-compiling-radare2-for-armhf-and-Buildroot/"><div class="card-body"> <em class="timeago small" data-ts="1739710800" > 2025-02-16 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Cross-compiling radare2 for armhf and Buildroot</h3><div class="text-muted small"><p> Introduction In this article, we will learn how to compile radare2 for armhf using Buildroot’s toolchain (note that this can be adapted to any other cross-toolchain you have, either you got it from...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/patch-an-executable-with-Python/" class="btn btn-outline-primary" prompt="Older"><p>Patch an executable with Python</p></a> <a href="/posts/macOS-theming/" class="btn btn-outline-primary" prompt="Newer"><p>Fulling theming macOS Big Sur</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2025 <a href="https://twitter.com/machxnu">MachXNU</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
